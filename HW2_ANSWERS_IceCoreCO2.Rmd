---
title: "Ice Core CO2"
author: "MSCI 599"
date: "11/6/2020"
output: html_document
---

# Unit I: Climate Change Module
### Exercise V: Longer term trends in CO2 Records
#### Skills: read, plot, save figure, merge data sets, for loops, conditionals, subsetting

The data we analyzed in the unit introduction included CO2 records dating back only as far as the measurements at the Manua Loa observatory.  To put these values into geological perspective requires looking back much farther than humans have been monitoring atmosopheric CO2 levels.  To do this, we need another approach.


[Ice core data](http://cdiac.ornl.gov/trends/co2/ice_core_co2.html):

Vostok Core, back to 400,000 yrs before present day 

- Description of data set: <http://cdiac.esd.ornl.gov/trends/co2/vostok.html>
- Data source: <https://cdiac.ess-dive.lbl.gov/ftp/trends/co2/vostok.icecore.co2>

## Questions / Tasks:

- Describe the data set: what are the columns and units? Where do the numbers come from? 
- What is the uncertainty in measurment? Resolution of the data? Interpretation of missing values?
- Read in and prepare data for analysis.
- Reverse the ordering to create a chronological record.  
- Plot data
- Consider various smoothing windowed averages of the data. 
- Join this series to Mauna Loa data
- Plot joined data
- Describe your conclusions


```{r}
# ice_core = read.table("data/vostok.icecore.co2.txt", skip=21, sep="", header = FALSE, col.names = c("Deph_m", "IceAge_yrBP", "AirAge_yrBP", "co2_ppmv"))
url = 'https://cdiac.ess-dive.lbl.gov/ftp/trends/co2/vostok.icecore.co2'
ice_core = read.delim(url, skip=21, sep="", header=FALSE, col.names = c("Depth_m", "IceAge_yrBP", "AirAge_yrBP", "co2_ppmv"))
head(ice_core)
```

The age of the ice core samples are provided as the age of the ice, and the mean age of the air pocket within the ice. Ages are provided in years BP, which means years prior to 1950. We can transform the age variable to reverse the order and create a chronological record:

```{r}
ice_core$year = 1950 - ice_core$AirAge_yrBP
tail(ice_core)
plot(co2_ppmv~year, data=ice_core, ylab="CO2 (ppmv)", xlab="year (relative to 1950)", type='l', main="Vostok ice core") 
```

```{r}
# Calculate and plot moving averages
ice_core$co2_ppmv_10kyr_avg = NA
ice_core$co2_ppmv_50kyr_avg = NA
for (i in seq(dim(ice_core)[1]))
{
  year_i = ice_core$year[i]
  
  # Calculate 10,000 year ice core moving average
  ice_core_10k_window = ice_core[which(ice_core$year > year_i-5000 & (ice_core$year < year_i+5000)),]
  ice_core$co2_ppmv_10kyr_avg[i] = mean(ice_core_10k_window$co2_ppmv)
  
  # Calculate 50,000 year ice core moving average
  ice_core_50k_window = ice_core[which(ice_core$year > year_i-25000 & (ice_core$year < year_i+25000)),]
  ice_core$co2_ppmv_50kyr_avg[i] = mean(ice_core_50k_window$co2_ppmv)
}

pdf('figures/vostok_ice_core.pdf', width=7, height=5)
plot(co2_ppmv~year, data=ice_core, ylab="CO2 (ppmv)", xlab="year (relative to 1950)", type='l', main="Vostok ice core") +
  lines(co2_ppmv_10kyr_avg~year, data=ice_core, col="red") +
  lines(co2_ppmv_50kyr_avg~year, data=ice_core, col="blue")
dev.off()
# Find CO2 range and highest CO2 value in Vostok ice core
range(ice_core$co2_ppmv)
ice_core[which(ice_core$co2_ppmv==max(ice_core$co2_ppmv)), ]
```

Over the last 400,000 years atmospheric CO2 levels as indicated by the ice-core data have fluctuated between 180 and 300 parts per million by volume (ppmv), corresponding with conditions of glacial and interglacial periods. The highest pre-industrial value recorded in 800,000 years of ice-core record was 298.7 ppmv, in the Vostok core, around 325,000 years ago. 

Now we'll bring in modern, post-industrial data collected at Mauna Loa to see how our atmospheric CO2 records compare with those derived from Antarctic ice core data:

```{r}
url = 'ftp://aftp.cmdl.noaa.gov/products/trends/co2/co2_mm_mlo.txt'
loa = read.table(url, col.names = c("year", "month", "decimal_date", "monthly_average", "deseasonalized", "n_days", "st_dev_days", "monthly_mean_uncertainty"))
head(loa)
```

Calculate the annual average of the deseasonalized CO2 readings from Mauna Loa and plot them:

```{r}
loa$annual_avg = NA
for (i in seq(dim(loa)[1]))
{
  loa_year_i = loa[which(loa$year == loa$year[i]),]
  loa$annual_avg[i] = mean(loa_year_i$deseasonalized)
}

plot(monthly_average ~ decimal_date, data = loa, type="l") +
  lines(annual_avg ~ year, data = loa, col="red")
```

This wasn't the most efficient way to solve this problem since we are re-calculating the same annual average for every month of a given year. That is unnecessarily repeating calculations. However, this was a simple way to code it given the tools that we have learned. Soon we will learn more efficient ways to make calculations on groups of data.

Now let's create a new dataset that merges the Vostok core data with the moder Mauna Loa data. I'm going to use the function `unique()` to remove repetitive rows of the annual average data in the Mauna Loa set. 

```{r}
head(loa)  # Note repetitive annual_avg data 
loa_annual = data.frame(year=loa$year, co2_ppmv=loa$annual_avg)
loa_annual = unique(loa_annual)
merged_co2 = rbind(ice_core[,c("year","co2_ppmv")],loa_annual) # Note: variable names must match for merge to be successful
merged_co2 = merged_co2[order(merged_co2$year),]  # reorder the data by year

pdf('figures/co2_400kBP_to_present.pdf', width=7, height=5)
plot(co2_ppmv ~ year, data = merged_co2, type="l") 
dev.off()

range(merged_co2$co2_ppmv)
```

Atmospheric CO2 levels have increased markedly in industrial times. The pre-industrial atmospheric CO2 maximum estimated from the Vostok ice core was 298.7 ppmv, around 325,000 years ago. Today the atmospheric CO2 measures 413 ppm. 
